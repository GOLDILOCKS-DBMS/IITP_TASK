--####################################################################
--# Product Type Profit Measure Query (Q9)
--####################################################################

--# This query determines how much profit is made on a given line 
--# of parts, broken out by supplier nation and year.

--###############################
--# Business Question
--###############################

--# The Product Type Profit Measure Query finds, for each nation 
--# and each year, the profit for all parts ordered in that year 
--# that contain a specified substring in their names and 
--# that were filled by a supplier in that nation. 
--# The profit is defined as the sum of 
--# [(l_extendedprice*(1-l_discount)) - (ps_supplycost * l_quantity)] 
--# for all lineitems describing parts in the specified line. 
--# The query lists the nations in ascending alphabetical order and, 
--# for each nation, the year and profit in descending order by year 
--# (most recent first).

\explain plan
select
    nation,
    o_year,
    ROUND( sum(amount), 2 ) as sum_profit
from (
       select
           n_name as nation,
           extract(year from o_orderdate) as o_year,
           l_extendedprice * (1 - l_discount) - ps_supplycost * l_quantity as amount
       from
           part,
           supplier,
           lineitem,
           partsupp,
           orders,
           nation
       where
             s_suppkey = l_suppkey
         and ps_suppkey = l_suppkey
         and ps_partkey = l_partkey
         and p_partkey = l_partkey
         and o_orderkey = l_orderkey
         and s_nationkey = n_nationkey
         and p_name like '%green%'
     ) profit
group by
    nation,
    o_year
order by
    nation,
    o_year desc;

NATION                    O_YEAR  SUM_PROFIT
------------------------- ------ -----------
ALGERIA                     1998 27136900.18
ALGERIA                     1997  48611833.5
ALGERIA                     1996 48285482.68
ALGERIA                     1995  44402273.6
ALGERIA                     1994 48694008.07
ALGERIA                     1993 46044207.78
ALGERIA                     1992 45636849.49
ARGENTINA                   1998 28341663.78
ARGENTINA                   1997 47143964.12
ARGENTINA                   1996  45255278.6
ARGENTINA                   1995 45631769.21
ARGENTINA                   1994 48268856.35
ARGENTINA                   1993 48605593.62
ARGENTINA                   1992 46654240.75
BRAZIL                      1998  26527736.4
BRAZIL                      1997 45640660.77
BRAZIL                      1996 45090647.16
BRAZIL                      1995 44015888.51
BRAZIL                      1994 44854218.89
BRAZIL                      1993 45766603.74

NATION                    O_YEAR  SUM_PROFIT
------------------------- ------ -----------
BRAZIL                      1992  45280216.8
CANADA                      1998 26828985.39
CANADA                      1997 44849954.32
CANADA                      1996 46307936.11
CANADA                      1995 47311993.04
CANADA                      1994 46691491.96
CANADA                      1993 46634791.11
CANADA                      1992 45873849.69
CHINA                       1998 27510180.17
CHINA                       1997 46123865.41
CHINA                       1996 49532807.06
CHINA                       1995 46734651.48
CHINA                       1994 46397896.61
CHINA                       1993 49634673.95
CHINA                       1992 46949457.64
EGYPT                       1998  28401491.8
EGYPT                       1997 47674857.68
EGYPT                       1996 47745727.55
EGYPT                       1995 45897160.68
EGYPT                       1994 47194895.23

NATION                    O_YEAR  SUM_PROFIT
------------------------- ------ -----------
EGYPT                       1993 49133627.65
EGYPT                       1992  47000574.5
ETHIOPIA                    1998 25135046.14
ETHIOPIA                    1997 43010596.08
ETHIOPIA                    1996 43636287.19
ETHIOPIA                    1995 43575757.33
ETHIOPIA                    1994 41597208.53
ETHIOPIA                    1993 42622804.16
ETHIOPIA                    1992 44385735.68
FRANCE                      1998 26210392.28
FRANCE                      1997 42392969.47
FRANCE                      1996 43306317.97
FRANCE                      1995 46377408.43
FRANCE                      1994 43447352.99
FRANCE                      1993 43729961.06
FRANCE                      1992 44052308.43
GERMANY                     1998 25991257.11
GERMANY                     1997 43968355.81
GERMANY                     1996  45882074.8
GERMANY                     1995 43314338.31

NATION                    O_YEAR  SUM_PROFIT
------------------------- ------ -----------
GERMANY                     1994 44616995.44
GERMANY                     1993 45126645.91
GERMANY                     1992 44361141.21
INDIA                       1998 29626417.24
INDIA                       1997 51386111.34
INDIA                       1996 47571018.51
INDIA                       1995 49344062.28
INDIA                       1994 50106952.43
INDIA                       1993  48112766.7
INDIA                       1992 47914303.12
INDONESIA                   1998 27734909.68
INDONESIA                   1997 44593812.99
INDONESIA                   1996 44746729.81
INDONESIA                   1995  45593622.7
INDONESIA                   1994 45988483.88
INDONESIA                   1993 46147963.79
INDONESIA                   1992 45185777.07
IRAN                        1998 26661608.93
IRAN                        1997 45019114.17
IRAN                        1996  45891397.1

NATION                    O_YEAR  SUM_PROFIT
------------------------- ------ -----------
IRAN                        1995 44414285.23
IRAN                        1994 43696360.48
IRAN                        1993 45362775.81
IRAN                        1992 43052338.41
IRAQ                        1998 31188498.19
IRAQ                        1997 48585307.52
IRAQ                        1996 50036593.84
IRAQ                        1995 48774801.73
IRAQ                        1994 48795847.23
IRAQ                        1993 47435691.51
IRAQ                        1992 47562355.66
JAPAN                       1998 24694102.17
JAPAN                       1997 42377052.35
JAPAN                       1996 40267778.91
JAPAN                       1995 40925317.47
JAPAN                       1994 41159518.31
JAPAN                       1993 39589074.28
JAPAN                       1992 39113493.91
JORDAN                      1998 23489867.79
JORDAN                      1997 41615962.66

NATION                    O_YEAR  SUM_PROFIT
------------------------- ------ -----------
JORDAN                      1996 41860855.47
JORDAN                      1995 39931672.09
JORDAN                      1994 40707555.46
JORDAN                      1993 39060405.47
JORDAN                      1992 41657604.27
KENYA                       1998 25566337.43
KENYA                       1997  43108847.9
KENYA                       1996 43482953.54
KENYA                       1995 42517988.98
KENYA                       1994 43612479.45
KENYA                       1993 42724038.76
KENYA                       1992 43217106.21
MOROCCO                     1998 24915496.88
MOROCCO                     1997 42698382.86
MOROCCO                     1996  42986113.5
MOROCCO                     1995 42316089.16
MOROCCO                     1994  43458604.6
MOROCCO                     1993 42672288.07
MOROCCO                     1992 42800781.64
MOZAMBIQUE                  1998 28279876.03

NATION                    O_YEAR  SUM_PROFIT
------------------------- ------ -----------
MOZAMBIQUE                  1997 51159216.23
MOZAMBIQUE                  1996 48072525.06
MOZAMBIQUE                  1995  48905200.6
MOZAMBIQUE                  1994 46092076.28
MOZAMBIQUE                  1993 48555926.27
MOZAMBIQUE                  1992 47809075.12
PERU                        1998 26713966.27
PERU                        1997  48324008.6
PERU                        1996 50310008.86
PERU                        1995 49647080.96
PERU                        1994 46420910.28
PERU                        1993 51536906.25
PERU                        1992 47711665.31
ROMANIA                     1998  27271993.1
ROMANIA                     1997  45063059.2
ROMANIA                     1996 47492335.03
ROMANIA                     1995 45710636.29
ROMANIA                     1994 46088041.11
ROMANIA                     1993 47515092.56
ROMANIA                     1992  44111439.8

NATION                    O_YEAR  SUM_PROFIT
------------------------- ------ -----------
RUSSIA                      1998 27935323.73
RUSSIA                      1997 48222347.29
RUSSIA                      1996 47553559.49
RUSSIA                      1995  46755990.1
RUSSIA                      1994 48000515.62
RUSSIA                      1993 48569624.51
RUSSIA                      1992 47672831.53
SAUDI ARABIA                1998 27113516.84
SAUDI ARABIA                1997 46690468.96
SAUDI ARABIA                1996 47775782.67
SAUDI ARABIA                1995 46657107.83
SAUDI ARABIA                1994 48181672.81
SAUDI ARABIA                1993 45692556.44
SAUDI ARABIA                1992 48924913.27
UNITED KINGDOM              1998 26366682.88
UNITED KINGDOM              1997 44518130.19
UNITED KINGDOM              1996 45539729.62
UNITED KINGDOM              1995 46845879.34
UNITED KINGDOM              1994 43081609.57
UNITED KINGDOM              1993 44770146.76

NATION                    O_YEAR  SUM_PROFIT
------------------------- ------ -----------
UNITED KINGDOM              1992 44123402.55
UNITED STATES               1998 27826593.68
UNITED STATES               1997 46638572.36
UNITED STATES               1996 46688280.55
UNITED STATES               1995 48951591.62
UNITED STATES               1994 45099092.06
UNITED STATES               1993 46181600.53
UNITED STATES               1992 46168214.09
VIETNAM                     1998    27281931
VIETNAM                     1997 48735914.18
VIETNAM                     1996  47824595.9
VIETNAM                     1995  48235135.8
VIETNAM                     1994 47729256.33
VIETNAM                     1993 45352676.87
VIETNAM                     1992 47846355.65

175 rows selected.

>>>  start print plan

< Execution Plan >
============================================================================================================================
|  IDX  |  NODE DESCRIPTION                                                                      |                    ROWS |
----------------------------------------------------------------------------------------------------------------------------
|    0  |  SELECT STATEMENT                                                                      |                     175 |
|    1  |    QUERY BLOCK ("$QB_IDX_2")                                                           |                     175 |
|    2  |      SORT INSTANT                                                                      |                     175 |
|    3  |        SINGLE CLUSTER                                                                  | LOCAL/REMOTE        175 |
|    4  |          CLUSTER PUSHER ("_$NI_10")                                                    |                   42656 |
|    5  |            PLAN BASED CLUSTER                                                          | LOCAL/REMOTE      42656 |
|    6  |              HASH JOIN (INNER JOIN)                                                    |                   21672 |
|    7  |                HASH JOIN (INNER JOIN)                                                  |                   21672 |
|    8  |                  NESTED JOIN (INNER JOIN)                                              |                   21672 |
|    9  |                    TABLE ACCESS ("PART")                                               |                    5418 |
|   10  |                    INDEX ACCESS ("PARTSUPP", "PARTSUPP_PARTKEY_FK")                    | (     21672)      21672 |
|   11  |                  HASH JOIN INSTANT                                                     |                   21672 |
|   12  |                    TABLE ACCESS ("SUPPLIER")                                           |                   10000 |
|   13  |                HASH JOIN INSTANT                                                       |                   21672 |
|   14  |                  TABLE ACCESS ("NATION")                                               |                      25 |
|   15  |          SELECT STATEMENT                                                              |                     175 |
|   16  |            QUERY BLOCK ("$QB_IDX_2")                                                   |                     175 |
|   17  |              GROUP HASH INSTANT                                                        |                     175 |
|   18  |                HASH JOIN (INNER JOIN)                                                  |                  159853 |
|   19  |                  TABLE ACCESS ("ORDERS" AS _A2)                                        |                  752453 |
|   20  |                  HASH JOIN INSTANT                                                     |                  159853 |
|   21  |                    NESTED JOIN (INNER JOIN)                                            |                  159853 |
|   22  |                      PUSHER TABLE ACCESS ("_$NI_10" AS _A4)                            |                   42656 |
|   23  |                      INDEX ACCESS ("LINEITEM" AS _A3, "LINEITEM_PARTKEY_SUPPKEY_FK")   | (    159853)     159853 |
============================================================================================================================

     1  -  TARGET : _$NI_10.N_NAME, EXTRACT( YEAR FROM ORDERS.O_ORDERDATE ), ROUND(SUM( ( LINEITEM.L_EXTENDEDPRICE * ( 1 - LINEITEM.L_DISCOUNT ) ) - ( _$NI_10.PS_SUPPLYCOST * LINEITEM.L_QUANTITY ) ),2) AS SUM_PROFIT
     2  -  SORT KEY : "_$NI_10.N_NAME ASC NULLS LAST", "EXTRACT( YEAR FROM ORDERS.O_ORDERDATE ) DESC NULLS LAST"
           RECORD COLUMN : ROUND(SUM( ( LINEITEM.L_EXTENDEDPRICE * ( 1 - LINEITEM.L_DISCOUNT ) ) - ( _$NI_10.PS_SUPPLYCOST * LINEITEM.L_QUANTITY ) ),2)
           READ KEY COLUMN : _$NI_10.N_NAME, EXTRACT( YEAR FROM ORDERS.O_ORDERDATE )
           READ RECORD COLUMN : ROUND(SUM( ( LINEITEM.L_EXTENDEDPRICE * ( 1 - LINEITEM.L_DISCOUNT ) ) - ( _$NI_10.PS_SUPPLYCOST * LINEITEM.L_QUANTITY ) ),2)
     3  -  SQL : SELECT /*+ USE_GROUP_HASH(250) KEEP_JOINED_TABLE USE_HASH_IN( _A1, 165606 ) FULL( _A2 ) USE_NL_IN( _A3 ) FULL( _A4 ) INDEX( _A3, "PUBLIC"."LINEITEM_PARTKEY_SUPPKEY_FK" ) */ "_A4"."N_NAME", EXTRACT(YEAR FROM "_A2"."O_ORDERDATE"), SUM( ("_A3"."L_EXTENDEDPRICE" * (:_V0 - "_A3"."L_DISCOUNT")) - ("_A4"."PS_SUPPLYCOST" * "_A3"."L_QUANTITY") ) FROM ( "PUBLIC"."ORDERS"@LOCAL AS "_A2" INNER JOIN ( "SESSION_SCHEMA"."_$NI_10"@LOCAL AS "_A4" INNER JOIN "PUBLIC"."LINEITEM"@LOCAL AS "_A3" ON true ) ALIAS "_A1" ON "_A3"."L_ORDERKEY" = "_A2"."O_ORDERKEY") ALIAS "_A5" WHERE "_A3"."L_PARTKEY" = "_A4"."PS_PARTKEY" AND "_A3"."L_SUPPKEY" = "_A4"."PS_SUPPKEY" GROUP BY "_A4"."N_NAME", EXTRACT(YEAR FROM "_A2"."O_ORDERDATE")
           TARGET DOMAIN : G1(G1N1) 175 rows, G2(G2N1) 175 rows
           RE-GROUPING
             GROUP KEY : _$NI_10.N_NAME, EXTRACT( YEAR FROM ORDERS.O_ORDERDATE )
             AGGREGATION : SUM( SUM( ( LINEITEM.L_EXTENDEDPRICE * ( 1 - LINEITEM.L_DISCOUNT ) ) - ( _$NI_10.PS_SUPPLYCOST * LINEITEM.L_QUANTITY ) ) )
     4  -  SQL : DECLARE INSTANT TABLE "SESSION_SCHEMA"."_$NI_10" ( "PS_PARTKEY" NUMBER(10, 0), "PS_SUPPKEY" NUMBER(10, 0), "N_NAME" CHAR(25 OCTETS), "PS_SUPPLYCOST" NUMBER(12, 2) ) 
           COLUMN : PARTSUPP.PS_PARTKEY AS PS_PARTKEY, PARTSUPP.PS_SUPPKEY AS PS_SUPPKEY, NATION.N_NAME AS N_NAME, PARTSUPP.PS_SUPPLYCOST AS PS_SUPPLYCOST
           CLONED
           TARGET DOMAIN : G1(G1N1) 42656 rows, G2(G2N1) 42656 rows
     5  -  SQL : SELECT /*+ KEEP_JOINED_TABLE USE_HASH_IN( _A1, 25 ) USE_HASH_IN( _A2, 10000 ) USE_NL_IN( _A3 ) FULL( _A4 ) INDEX( _A3, "PUBLIC"."PARTSUPP_PARTKEY_FK" ) FULL( _A2 ) FULL( _A1 ) */ "_A3"."PS_PARTKEY", "_A3"."PS_SUPPKEY", "_A1"."N_NAME", "_A3"."PS_SUPPLYCOST" FROM ( ( ( "PUBLIC"."PART"@LOCAL AS "_A4" INNER JOIN "PUBLIC"."PARTSUPP"@LOCAL AS "_A3" ON true ) ALIAS "_A5" INNER JOIN "PUBLIC"."SUPPLIER"@LOCAL AS "_A2" ON "_A2"."S_SUPPKEY" = "_A3"."PS_SUPPKEY") ALIAS "_A6" INNER JOIN "PUBLIC"."NATION"@LOCAL AS "_A1" ON "_A1"."N_NATIONKEY" = "_A2"."S_NATIONKEY") ALIAS "_A7" WHERE "_A4"."P_NAME" LIKE :_V0 AND "_A3"."PS_PARTKEY" = "_A4"."P_PARTKEY"
           TARGET DOMAIN : G1(G1N1) 21672 rows, G2(G2N1) 20984 rows
     6  -  JOINED COLUMN : PARTSUPP.PS_PARTKEY, PARTSUPP.PS_SUPPKEY, NATION.N_NAME, PARTSUPP.PS_SUPPLYCOST
     7  -  JOINED COLUMN : SUPPLIER.S_NATIONKEY, PARTSUPP.PS_PARTKEY, PARTSUPP.PS_SUPPKEY, PARTSUPP.PS_SUPPLYCOST
     8  -  JOINED COLUMN : PARTSUPP.PS_SUPPKEY, PARTSUPP.PS_PARTKEY, PARTSUPP.PS_SUPPLYCOST
     9  -  HASH SHARD ( # 3 ) 
           READ COLUMN : PART.P_PARTKEY, PART.P_NAME
             NODE FILTER : PART.P_NAME LIKE '%green%'
    10  -  HASH SHARD ( # 3 ) 
           READ INDEX COLUMN : PARTSUPP.PS_PARTKEY
           READ TABLE COLUMN : PARTSUPP.PS_SUPPKEY, PARTSUPP.PS_SUPPLYCOST
             MIN RANGE : PARTSUPP.PS_PARTKEY = {PART.P_PARTKEY}
             MAX RANGE : PARTSUPP.PS_PARTKEY = {PART.P_PARTKEY}
    11  -  HASH KEY : SUPPLIER.S_SUPPKEY
           RECORD COLUMN : SUPPLIER.S_NATIONKEY
           READ KEY COLUMN : SUPPLIER.S_SUPPKEY, SUPPLIER.S_NATIONKEY
             HASH FILTER : SUPPLIER.S_SUPPKEY = PARTSUPP.PS_SUPPKEY
           FETCH ONE ROW
    12  -  CLONED 
           READ COLUMN : SUPPLIER.S_SUPPKEY, SUPPLIER.S_NATIONKEY
    13  -  HASH KEY : NATION.N_NATIONKEY
           RECORD COLUMN : NATION.N_NAME
           READ KEY COLUMN : NATION.N_NATIONKEY, NATION.N_NAME
             HASH FILTER : NATION.N_NATIONKEY = SUPPLIER.S_NATIONKEY
           FETCH ONE ROW
    14  -  CLONED 
           READ COLUMN : NATION.N_NATIONKEY, NATION.N_NAME
    16  -  TARGET : _A4.N_NAME, EXTRACT( YEAR FROM _A2.O_ORDERDATE ), SUM( ( _A3.L_EXTENDEDPRICE * ( :_V0 - _A3.L_DISCOUNT ) ) - ( _A4.PS_SUPPLYCOST * _A3.L_QUANTITY ) )
    17  -  GROUP KEY : _A4.N_NAME, EXTRACT( YEAR FROM _A2.O_ORDERDATE )
           RECORD COLUMN : SUM( ( _A3.L_EXTENDEDPRICE * ( :_V0 - _A3.L_DISCOUNT ) ) - ( _A4.PS_SUPPLYCOST * _A3.L_QUANTITY ) )
           READ KEY COLUMN : _A4.N_NAME, EXTRACT( YEAR FROM _A2.O_ORDERDATE )
           READ RECORD COLUMN : SUM( ( _A3.L_EXTENDEDPRICE * ( :_V0 - _A3.L_DISCOUNT ) ) - ( _A4.PS_SUPPLYCOST * _A3.L_QUANTITY ) )
    18  -  JOINED COLUMN : _A4.N_NAME, _A2.O_ORDERDATE, _A3.L_EXTENDEDPRICE, _A3.L_DISCOUNT, _A4.PS_SUPPLYCOST, _A3.L_QUANTITY
    19  -  HASH SHARD ( # 3 ) 
           READ COLUMN : _A2.O_ORDERKEY, _A2.O_ORDERDATE
    20  -  HASH KEY : _A3.L_ORDERKEY
           RECORD COLUMN : _A4.N_NAME, _A3.L_EXTENDEDPRICE, _A3.L_DISCOUNT, _A4.PS_SUPPLYCOST, _A3.L_QUANTITY
           READ KEY COLUMN : _A3.L_ORDERKEY, _A4.N_NAME, _A3.L_EXTENDEDPRICE, _A3.L_DISCOUNT, _A4.PS_SUPPLYCOST, _A3.L_QUANTITY
             HASH FILTER : _A3.L_ORDERKEY = _A2.O_ORDERKEY
    21  -  JOINED COLUMN : _A3.L_ORDERKEY, _A4.N_NAME, _A3.L_EXTENDEDPRICE, _A3.L_DISCOUNT, _A4.PS_SUPPLYCOST, _A3.L_QUANTITY
             CONSTANT FILTER : TRUE
    22  -  READ COLUMN : _A4.PS_PARTKEY, _A4.PS_SUPPKEY, _A4.N_NAME, _A4.PS_SUPPLYCOST
    23  -  HASH SHARD ( # 3 ) 
           READ INDEX COLUMN : _A3.L_PARTKEY, _A3.L_SUPPKEY
           READ TABLE COLUMN : _A3.L_ORDERKEY, _A3.L_QUANTITY, _A3.L_EXTENDEDPRICE, _A3.L_DISCOUNT
             MIN RANGE : _A3.L_PARTKEY = {_A4.PS_PARTKEY} AND _A3.L_SUPPKEY = {_A4.PS_SUPPKEY}
             MAX RANGE : _A3.L_PARTKEY = {_A4.PS_PARTKEY} AND _A3.L_SUPPKEY = {_A4.PS_SUPPKEY}

<<<  end print plan



--###############################
--# Functional Query Definition
--###############################

\set linesize 400
\set timing on;

--# result: 175 rows
--#           nation           | o_year | sum_profit  
--# ---------------------------+--------+-------------
--#  ALGERIA                   |   1998 | 27136900.18
--#  ALGERIA                   |   1997 |  48611833.5
--#  ......
--#  ......
--#  ......
--#  VIETNAM                   |   1993 | 45352676.87
--#  VIETNAM                   |   1992 | 47846355.65
\explain plan
select
    nation,
    o_year,
    ROUND( sum(amount), 2 ) as sum_profit
from (
       select
           n_name as nation,
           extract(year from o_orderdate) as o_year,
           l_extendedprice * (1 - l_discount) - ps_supplycost * l_quantity as amount
       from
           part,
           supplier,
           lineitem,
           partsupp,
           orders,
           nation
       where
             s_suppkey = l_suppkey
         and ps_suppkey = l_suppkey
         and ps_partkey = l_partkey
         and p_partkey = l_partkey
         and o_orderkey = l_orderkey
         and s_nationkey = n_nationkey
         and p_name like '%green%'
     ) profit
group by
    nation,
    o_year
order by
    nation,
    o_year desc;

NATION                    O_YEAR  SUM_PROFIT
------------------------- ------ -----------
ALGERIA                     1998 27136900.18
ALGERIA                     1997  48611833.5
ALGERIA                     1996 48285482.68
ALGERIA                     1995  44402273.6
ALGERIA                     1994 48694008.07
ALGERIA                     1993 46044207.78
ALGERIA                     1992 45636849.49
ARGENTINA                   1998 28341663.78
ARGENTINA                   1997 47143964.12
ARGENTINA                   1996  45255278.6
ARGENTINA                   1995 45631769.21
ARGENTINA                   1994 48268856.35
ARGENTINA                   1993 48605593.62
ARGENTINA                   1992 46654240.75
BRAZIL                      1998  26527736.4
BRAZIL                      1997 45640660.77
BRAZIL                      1996 45090647.16
BRAZIL                      1995 44015888.51
BRAZIL                      1994 44854218.89
BRAZIL                      1993 45766603.74

NATION                    O_YEAR  SUM_PROFIT
------------------------- ------ -----------
BRAZIL                      1992  45280216.8
CANADA                      1998 26828985.39
CANADA                      1997 44849954.32
CANADA                      1996 46307936.11
CANADA                      1995 47311993.04
CANADA                      1994 46691491.96
CANADA                      1993 46634791.11
CANADA                      1992 45873849.69
CHINA                       1998 27510180.17
CHINA                       1997 46123865.41
CHINA                       1996 49532807.06
CHINA                       1995 46734651.48
CHINA                       1994 46397896.61
CHINA                       1993 49634673.95
CHINA                       1992 46949457.64
EGYPT                       1998  28401491.8
EGYPT                       1997 47674857.68
EGYPT                       1996 47745727.55
EGYPT                       1995 45897160.68
EGYPT                       1994 47194895.23

NATION                    O_YEAR  SUM_PROFIT
------------------------- ------ -----------
EGYPT                       1993 49133627.65
EGYPT                       1992  47000574.5
ETHIOPIA                    1998 25135046.14
ETHIOPIA                    1997 43010596.08
ETHIOPIA                    1996 43636287.19
ETHIOPIA                    1995 43575757.33
ETHIOPIA                    1994 41597208.53
ETHIOPIA                    1993 42622804.16
ETHIOPIA                    1992 44385735.68
FRANCE                      1998 26210392.28
FRANCE                      1997 42392969.47
FRANCE                      1996 43306317.97
FRANCE                      1995 46377408.43
FRANCE                      1994 43447352.99
FRANCE                      1993 43729961.06
FRANCE                      1992 44052308.43
GERMANY                     1998 25991257.11
GERMANY                     1997 43968355.81
GERMANY                     1996  45882074.8
GERMANY                     1995 43314338.31

NATION                    O_YEAR  SUM_PROFIT
------------------------- ------ -----------
GERMANY                     1994 44616995.44
GERMANY                     1993 45126645.91
GERMANY                     1992 44361141.21
INDIA                       1998 29626417.24
INDIA                       1997 51386111.34
INDIA                       1996 47571018.51
INDIA                       1995 49344062.28
INDIA                       1994 50106952.43
INDIA                       1993  48112766.7
INDIA                       1992 47914303.12
INDONESIA                   1998 27734909.68
INDONESIA                   1997 44593812.99
INDONESIA                   1996 44746729.81
INDONESIA                   1995  45593622.7
INDONESIA                   1994 45988483.88
INDONESIA                   1993 46147963.79
INDONESIA                   1992 45185777.07
IRAN                        1998 26661608.93
IRAN                        1997 45019114.17
IRAN                        1996  45891397.1

NATION                    O_YEAR  SUM_PROFIT
------------------------- ------ -----------
IRAN                        1995 44414285.23
IRAN                        1994 43696360.48
IRAN                        1993 45362775.81
IRAN                        1992 43052338.41
IRAQ                        1998 31188498.19
IRAQ                        1997 48585307.52
IRAQ                        1996 50036593.84
IRAQ                        1995 48774801.73
IRAQ                        1994 48795847.23
IRAQ                        1993 47435691.51
IRAQ                        1992 47562355.66
JAPAN                       1998 24694102.17
JAPAN                       1997 42377052.35
JAPAN                       1996 40267778.91
JAPAN                       1995 40925317.47
JAPAN                       1994 41159518.31
JAPAN                       1993 39589074.28
JAPAN                       1992 39113493.91
JORDAN                      1998 23489867.79
JORDAN                      1997 41615962.66

NATION                    O_YEAR  SUM_PROFIT
------------------------- ------ -----------
JORDAN                      1996 41860855.47
JORDAN                      1995 39931672.09
JORDAN                      1994 40707555.46
JORDAN                      1993 39060405.47
JORDAN                      1992 41657604.27
KENYA                       1998 25566337.43
KENYA                       1997  43108847.9
KENYA                       1996 43482953.54
KENYA                       1995 42517988.98
KENYA                       1994 43612479.45
KENYA                       1993 42724038.76
KENYA                       1992 43217106.21
MOROCCO                     1998 24915496.88
MOROCCO                     1997 42698382.86
MOROCCO                     1996  42986113.5
MOROCCO                     1995 42316089.16
MOROCCO                     1994  43458604.6
MOROCCO                     1993 42672288.07
MOROCCO                     1992 42800781.64
MOZAMBIQUE                  1998 28279876.03

NATION                    O_YEAR  SUM_PROFIT
------------------------- ------ -----------
MOZAMBIQUE                  1997 51159216.23
MOZAMBIQUE                  1996 48072525.06
MOZAMBIQUE                  1995  48905200.6
MOZAMBIQUE                  1994 46092076.28
MOZAMBIQUE                  1993 48555926.27
MOZAMBIQUE                  1992 47809075.12
PERU                        1998 26713966.27
PERU                        1997  48324008.6
PERU                        1996 50310008.86
PERU                        1995 49647080.96
PERU                        1994 46420910.28
PERU                        1993 51536906.25
PERU                        1992 47711665.31
ROMANIA                     1998  27271993.1
ROMANIA                     1997  45063059.2
ROMANIA                     1996 47492335.03
ROMANIA                     1995 45710636.29
ROMANIA                     1994 46088041.11
ROMANIA                     1993 47515092.56
ROMANIA                     1992  44111439.8

NATION                    O_YEAR  SUM_PROFIT
------------------------- ------ -----------
RUSSIA                      1998 27935323.73
RUSSIA                      1997 48222347.29
RUSSIA                      1996 47553559.49
RUSSIA                      1995  46755990.1
RUSSIA                      1994 48000515.62
RUSSIA                      1993 48569624.51
RUSSIA                      1992 47672831.53
SAUDI ARABIA                1998 27113516.84
SAUDI ARABIA                1997 46690468.96
SAUDI ARABIA                1996 47775782.67
SAUDI ARABIA                1995 46657107.83
SAUDI ARABIA                1994 48181672.81
SAUDI ARABIA                1993 45692556.44
SAUDI ARABIA                1992 48924913.27
UNITED KINGDOM              1998 26366682.88
UNITED KINGDOM              1997 44518130.19
UNITED KINGDOM              1996 45539729.62
UNITED KINGDOM              1995 46845879.34
UNITED KINGDOM              1994 43081609.57
UNITED KINGDOM              1993 44770146.76

NATION                    O_YEAR  SUM_PROFIT
------------------------- ------ -----------
UNITED KINGDOM              1992 44123402.55
UNITED STATES               1998 27826593.68
UNITED STATES               1997 46638572.36
UNITED STATES               1996 46688280.55
UNITED STATES               1995 48951591.62
UNITED STATES               1994 45099092.06
UNITED STATES               1993 46181600.53
UNITED STATES               1992 46168214.09
VIETNAM                     1998    27281931
VIETNAM                     1997 48735914.18
VIETNAM                     1996  47824595.9
VIETNAM                     1995  48235135.8
VIETNAM                     1994 47729256.33
VIETNAM                     1993 45352676.87
VIETNAM                     1992 47846355.65

175 rows selected.

>>>  start print plan

< Execution Plan >
============================================================================================================================
|  IDX  |  NODE DESCRIPTION                                                                      |                    ROWS |
----------------------------------------------------------------------------------------------------------------------------
|    0  |  SELECT STATEMENT                                                                      |                     175 |
|    1  |    QUERY BLOCK ("$QB_IDX_2")                                                           |                     175 |
|    2  |      SORT INSTANT                                                                      |                     175 |
|    3  |        SINGLE CLUSTER                                                                  | LOCAL/REMOTE        175 |
|    4  |          CLUSTER PUSHER ("_$NI_10")                                                    |                   42656 |
|    5  |            PLAN BASED CLUSTER                                                          | LOCAL/REMOTE      42656 |
|    6  |              HASH JOIN (INNER JOIN)                                                    |                   21672 |
|    7  |                HASH JOIN (INNER JOIN)                                                  |                   21672 |
|    8  |                  NESTED JOIN (INNER JOIN)                                              |                   21672 |
|    9  |                    TABLE ACCESS ("PART")                                               |                    5418 |
|   10  |                    INDEX ACCESS ("PARTSUPP", "PARTSUPP_PARTKEY_FK")                    | (     21672)      21672 |
|   11  |                  HASH JOIN INSTANT                                                     |                   21672 |
|   12  |                    TABLE ACCESS ("SUPPLIER")                                           |                   10000 |
|   13  |                HASH JOIN INSTANT                                                       |                   21672 |
|   14  |                  TABLE ACCESS ("NATION")                                               |                      25 |
|   15  |          SELECT STATEMENT                                                              |                     175 |
|   16  |            QUERY BLOCK ("$QB_IDX_2")                                                   |                     175 |
|   17  |              GROUP HASH INSTANT                                                        |                     175 |
|   18  |                HASH JOIN (INNER JOIN)                                                  |                  159853 |
|   19  |                  TABLE ACCESS ("ORDERS" AS _A2)                                        |                  752453 |
|   20  |                  HASH JOIN INSTANT                                                     |                  159853 |
|   21  |                    NESTED JOIN (INNER JOIN)                                            |                  159853 |
|   22  |                      PUSHER TABLE ACCESS ("_$NI_10" AS _A4)                            |                   42656 |
|   23  |                      INDEX ACCESS ("LINEITEM" AS _A3, "LINEITEM_PARTKEY_SUPPKEY_FK")   | (    159853)     159853 |
============================================================================================================================

     1  -  TARGET : _$NI_10.N_NAME, EXTRACT( YEAR FROM ORDERS.O_ORDERDATE ), ROUND(SUM( ( LINEITEM.L_EXTENDEDPRICE * ( 1 - LINEITEM.L_DISCOUNT ) ) - ( _$NI_10.PS_SUPPLYCOST * LINEITEM.L_QUANTITY ) ),2) AS SUM_PROFIT
     2  -  SORT KEY : "_$NI_10.N_NAME ASC NULLS LAST", "EXTRACT( YEAR FROM ORDERS.O_ORDERDATE ) DESC NULLS LAST"
           RECORD COLUMN : ROUND(SUM( ( LINEITEM.L_EXTENDEDPRICE * ( 1 - LINEITEM.L_DISCOUNT ) ) - ( _$NI_10.PS_SUPPLYCOST * LINEITEM.L_QUANTITY ) ),2)
           READ KEY COLUMN : _$NI_10.N_NAME, EXTRACT( YEAR FROM ORDERS.O_ORDERDATE )
           READ RECORD COLUMN : ROUND(SUM( ( LINEITEM.L_EXTENDEDPRICE * ( 1 - LINEITEM.L_DISCOUNT ) ) - ( _$NI_10.PS_SUPPLYCOST * LINEITEM.L_QUANTITY ) ),2)
     3  -  SQL : SELECT /*+ USE_GROUP_HASH(250) KEEP_JOINED_TABLE USE_HASH_IN( _A1, 165606 ) FULL( _A2 ) USE_NL_IN( _A3 ) FULL( _A4 ) INDEX( _A3, "PUBLIC"."LINEITEM_PARTKEY_SUPPKEY_FK" ) */ "_A4"."N_NAME", EXTRACT(YEAR FROM "_A2"."O_ORDERDATE"), SUM( ("_A3"."L_EXTENDEDPRICE" * (:_V0 - "_A3"."L_DISCOUNT")) - ("_A4"."PS_SUPPLYCOST" * "_A3"."L_QUANTITY") ) FROM ( "PUBLIC"."ORDERS"@LOCAL AS "_A2" INNER JOIN ( "SESSION_SCHEMA"."_$NI_10"@LOCAL AS "_A4" INNER JOIN "PUBLIC"."LINEITEM"@LOCAL AS "_A3" ON true ) ALIAS "_A1" ON "_A3"."L_ORDERKEY" = "_A2"."O_ORDERKEY") ALIAS "_A5" WHERE "_A3"."L_PARTKEY" = "_A4"."PS_PARTKEY" AND "_A3"."L_SUPPKEY" = "_A4"."PS_SUPPKEY" GROUP BY "_A4"."N_NAME", EXTRACT(YEAR FROM "_A2"."O_ORDERDATE")
           TARGET DOMAIN : G1(G1N1) 175 rows, G2(G2N1) 175 rows
           RE-GROUPING
             GROUP KEY : _$NI_10.N_NAME, EXTRACT( YEAR FROM ORDERS.O_ORDERDATE )
             AGGREGATION : SUM( SUM( ( LINEITEM.L_EXTENDEDPRICE * ( 1 - LINEITEM.L_DISCOUNT ) ) - ( _$NI_10.PS_SUPPLYCOST * LINEITEM.L_QUANTITY ) ) )
     4  -  SQL : DECLARE INSTANT TABLE "SESSION_SCHEMA"."_$NI_10" ( "PS_PARTKEY" NUMBER(10, 0), "PS_SUPPKEY" NUMBER(10, 0), "N_NAME" CHAR(25 OCTETS), "PS_SUPPLYCOST" NUMBER(12, 2) ) 
           COLUMN : PARTSUPP.PS_PARTKEY AS PS_PARTKEY, PARTSUPP.PS_SUPPKEY AS PS_SUPPKEY, NATION.N_NAME AS N_NAME, PARTSUPP.PS_SUPPLYCOST AS PS_SUPPLYCOST
           CLONED
           TARGET DOMAIN : G1(G1N1) 42656 rows, G2(G2N1) 42656 rows
     5  -  SQL : SELECT /*+ KEEP_JOINED_TABLE USE_HASH_IN( _A1, 25 ) USE_HASH_IN( _A2, 10000 ) USE_NL_IN( _A3 ) FULL( _A4 ) INDEX( _A3, "PUBLIC"."PARTSUPP_PARTKEY_FK" ) FULL( _A2 ) FULL( _A1 ) */ "_A3"."PS_PARTKEY", "_A3"."PS_SUPPKEY", "_A1"."N_NAME", "_A3"."PS_SUPPLYCOST" FROM ( ( ( "PUBLIC"."PART"@LOCAL AS "_A4" INNER JOIN "PUBLIC"."PARTSUPP"@LOCAL AS "_A3" ON true ) ALIAS "_A5" INNER JOIN "PUBLIC"."SUPPLIER"@LOCAL AS "_A2" ON "_A2"."S_SUPPKEY" = "_A3"."PS_SUPPKEY") ALIAS "_A6" INNER JOIN "PUBLIC"."NATION"@LOCAL AS "_A1" ON "_A1"."N_NATIONKEY" = "_A2"."S_NATIONKEY") ALIAS "_A7" WHERE "_A4"."P_NAME" LIKE :_V0 AND "_A3"."PS_PARTKEY" = "_A4"."P_PARTKEY"
           TARGET DOMAIN : G1(G1N1) 21672 rows, G2(G2N1) 20984 rows
     6  -  JOINED COLUMN : PARTSUPP.PS_PARTKEY, PARTSUPP.PS_SUPPKEY, NATION.N_NAME, PARTSUPP.PS_SUPPLYCOST
     7  -  JOINED COLUMN : SUPPLIER.S_NATIONKEY, PARTSUPP.PS_PARTKEY, PARTSUPP.PS_SUPPKEY, PARTSUPP.PS_SUPPLYCOST
     8  -  JOINED COLUMN : PARTSUPP.PS_SUPPKEY, PARTSUPP.PS_PARTKEY, PARTSUPP.PS_SUPPLYCOST
     9  -  HASH SHARD ( # 3 ) 
           READ COLUMN : PART.P_PARTKEY, PART.P_NAME
             NODE FILTER : PART.P_NAME LIKE '%green%'
    10  -  HASH SHARD ( # 3 ) 
           READ INDEX COLUMN : PARTSUPP.PS_PARTKEY
           READ TABLE COLUMN : PARTSUPP.PS_SUPPKEY, PARTSUPP.PS_SUPPLYCOST
             MIN RANGE : PARTSUPP.PS_PARTKEY = {PART.P_PARTKEY}
             MAX RANGE : PARTSUPP.PS_PARTKEY = {PART.P_PARTKEY}
    11  -  HASH KEY : SUPPLIER.S_SUPPKEY
           RECORD COLUMN : SUPPLIER.S_NATIONKEY
           READ KEY COLUMN : SUPPLIER.S_SUPPKEY, SUPPLIER.S_NATIONKEY
             HASH FILTER : SUPPLIER.S_SUPPKEY = PARTSUPP.PS_SUPPKEY
           FETCH ONE ROW
    12  -  CLONED 
           READ COLUMN : SUPPLIER.S_SUPPKEY, SUPPLIER.S_NATIONKEY
    13  -  HASH KEY : NATION.N_NATIONKEY
           RECORD COLUMN : NATION.N_NAME
           READ KEY COLUMN : NATION.N_NATIONKEY, NATION.N_NAME
             HASH FILTER : NATION.N_NATIONKEY = SUPPLIER.S_NATIONKEY
           FETCH ONE ROW
    14  -  CLONED 
           READ COLUMN : NATION.N_NATIONKEY, NATION.N_NAME
    16  -  TARGET : _A4.N_NAME, EXTRACT( YEAR FROM _A2.O_ORDERDATE ), SUM( ( _A3.L_EXTENDEDPRICE * ( :_V0 - _A3.L_DISCOUNT ) ) - ( _A4.PS_SUPPLYCOST * _A3.L_QUANTITY ) )
    17  -  GROUP KEY : _A4.N_NAME, EXTRACT( YEAR FROM _A2.O_ORDERDATE )
           RECORD COLUMN : SUM( ( _A3.L_EXTENDEDPRICE * ( :_V0 - _A3.L_DISCOUNT ) ) - ( _A4.PS_SUPPLYCOST * _A3.L_QUANTITY ) )
           READ KEY COLUMN : _A4.N_NAME, EXTRACT( YEAR FROM _A2.O_ORDERDATE )
           READ RECORD COLUMN : SUM( ( _A3.L_EXTENDEDPRICE * ( :_V0 - _A3.L_DISCOUNT ) ) - ( _A4.PS_SUPPLYCOST * _A3.L_QUANTITY ) )
    18  -  JOINED COLUMN : _A4.N_NAME, _A2.O_ORDERDATE, _A3.L_EXTENDEDPRICE, _A3.L_DISCOUNT, _A4.PS_SUPPLYCOST, _A3.L_QUANTITY
    19  -  HASH SHARD ( # 3 ) 
           READ COLUMN : _A2.O_ORDERKEY, _A2.O_ORDERDATE
    20  -  HASH KEY : _A3.L_ORDERKEY
           RECORD COLUMN : _A4.N_NAME, _A3.L_EXTENDEDPRICE, _A3.L_DISCOUNT, _A4.PS_SUPPLYCOST, _A3.L_QUANTITY
           READ KEY COLUMN : _A3.L_ORDERKEY, _A4.N_NAME, _A3.L_EXTENDEDPRICE, _A3.L_DISCOUNT, _A4.PS_SUPPLYCOST, _A3.L_QUANTITY
             HASH FILTER : _A3.L_ORDERKEY = _A2.O_ORDERKEY
    21  -  JOINED COLUMN : _A3.L_ORDERKEY, _A4.N_NAME, _A3.L_EXTENDEDPRICE, _A3.L_DISCOUNT, _A4.PS_SUPPLYCOST, _A3.L_QUANTITY
             CONSTANT FILTER : TRUE
    22  -  READ COLUMN : _A4.PS_PARTKEY, _A4.PS_SUPPKEY, _A4.N_NAME, _A4.PS_SUPPLYCOST
    23  -  HASH SHARD ( # 3 ) 
           READ INDEX COLUMN : _A3.L_PARTKEY, _A3.L_SUPPKEY
           READ TABLE COLUMN : _A3.L_ORDERKEY, _A3.L_QUANTITY, _A3.L_EXTENDEDPRICE, _A3.L_DISCOUNT
             MIN RANGE : _A3.L_PARTKEY = {_A4.PS_PARTKEY} AND _A3.L_SUPPKEY = {_A4.PS_SUPPKEY}
             MAX RANGE : _A3.L_PARTKEY = {_A4.PS_PARTKEY} AND _A3.L_SUPPKEY = {_A4.PS_SUPPKEY}

<<<  end print plan


Elapsed time: 701.23700 ms 


--#################################
--# Report
--#################################

\set timing off;

INSERT INTO TPCH_SF1_REPORT 
       VALUES ( 'SF1_Q09', (:VAR_ELAPSED_TIME__ / 1000), TRUNC( 60 * 60 * 1000 / :VAR_ELAPSED_TIME__, 0 ) );

1 row created.

COMMIT;

Commit complete.

